<?php

$mycookie = 'datacenter=cwdc; visitorId=cwdc-A11d57d0c-9e80-4903-8697-d77b1b5ae89f; APISID=be8bf9e6-a34e-483c-9309-e8689e36748a; digital-token=c62da3a1-f028-4700-a784-2e934b6687e4-11-cwdc-mr4753; region=useast1; optimizelyEndUserId=oeu1682453900484r0.8156270510527024; _gcl_au=1.1.293317964.1682453933; __qca=P0-867025579-1682453948212; pxcts=72134ae0-e3a6-11ed-8ce7-4e4148547870; _pxvid=721335c3-e3a6-11ed-8ce7-4e4148547870; QuantumMetricUserID=4f01e34040f2c48f318bfb8af495a9b3; _fbp=fb.1.1682453977283.1305752564; akaalb_production_config=~op=avis_useast1_webapi_private_lbid:avis-webapi-useast1-aws|avis_com:avis-us-digital-useast1-aws|~rv=76~m=avis-webapi-useast1-aws:0|avis-us-digital-useast1-aws:0|~os=7f956ca2417c5e686d715889b6a30f65~id=8661c2a99422d53af484f8792993eacd; _pxhd=7ce3f1782a4dc1f72337e94634a8050116935e393a1c8fb16a19ec4eb94a5573:721335c3-e3a6-11ed-8ce7-4e4148547870; _gid=GA1.2.1801406899.1683197033; _clck=7g3r8s|1|fbb|0; SessionPersistence=PROFILEDATA%3A%3DauthorizableId%253Danonymous; bounceClientVisit2252v=N4IgNgDiBcIBYBcEQM4FIDMBBNAmAYnvgO6kB0AhgG4CWKZAxgPYC2RApgHZFyvsgAaEACcYIUsUq16zFoJB0A+gHMmilOxQoaTTjABmFMBqFLlEdZu26DRjQF8gA; QuantumMetricSessionID=34adbf2b53721f3491a7709f2b0ba0f9; _gat_UA-6997633-3=1; _ga_8L27T28KZS=GS1.1.1683220122.9.1.1683227043.57.0.0; _uetsid=9116a780ea6811ed8927cd44226f92a1; _uetvid=6e772780e3a611eda306a3d6364fbda2; _ga=GA1.2.48087019.1682453947; _clsk=dvmure|1683227048266|11|0|s.clarity.ms/collect; _px2=eyJ1IjoiNzdiMDg2YTAtZWFhZS0xMWVkLTk3MGQtODcwNTJiMTY5YmI4IiwidiI6IjcyMTMzNWMzLWUzYTYtMTFlZC04Y2U3LTRlNDE0ODU0Nzg3MCIsInQiOjE2ODMyMjczNjA3MjcsImgiOiIxMjdhMjk3MzBhMDc2NmM3NzMxOTVmNWJiODMwNzVmZjk2YTRiMWY4MWMxOGYzN2E5NDBhMWNjYTc1ZGY0MzkyIn0=; RT="z=1&dm=avis.com&si=d4f2f80e-675c-4436-8d2e-031048187205&ss=lh9dw5bu&sl=c&tt=g2bz&bcn=%2F%2F684dd32e.akstat.io%2F&ld=41d0w&nu=43hl6rgh&cl=41lm0"';
$digitoken = 'eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiZGlyIn0..2m3Y_vdCN635uDK_.c7R1rk2SoyROCqKG0Wi9ZKmtkXXi05OWhRlFJryoKHoFCguJgEY-QIIfiK3hd-HLkBCIpA5aLQKcjiCtDvSwSayy1fCF04R2ZRx_ZV9JOw3-ZgRfNbDUxlVB4T9fzas6tmwLbpoo6MjANY7YwRnCMzZMDqliVdkPIz4Hs40W7Y4XGf0pV20nYubyuLpExaSatK0ZyXbXCupB7XMztVZ0k81qJnIBSJa2KvK2gmhPkKQHT_29Vr7IeFWuMg8LsKHyTuRmm5kpG-Su7dbL2KzIpjRRiKHDgl4tNSn6WtQzLzEPoOtO-UaHMYt5OxgTrq7_EsgTeMQN-7i-hUKr_SP1zi4tBtNUwX7UzgsmJrNpSGSVOXc4MqXmIdtu0DVzW6v-xYSLhCzZ6w3tXODqxPJKkMiH6tyalC6FeFp6R5ttRYIALXmqhq3s-ulgT_U9lmLQoLh38seNvTbYxxwYiZMCdlxJThOdHKzEPSq7GHVpYfkQnAWqtCycx2qhGowjbLnegNKwgvzDCkVFa4NoE744ENoNVtRWhoU_7dQJMR1QlsKbzknNmoC9XIxQG8aFMqlkJpvl2mUxY-CwefAoFJglUIcv1NP1X2M2gYAuGBCNMW1Yy9vEDfEyxSo-ApoHOiBsG1QHU6DV9nn_uIGPwRqwzh2mNtFpV2tvz8uA9JIb1otUCWno9kukWucgJWeIJOsm11JPfap7m6-19Tv80cnLGXwKjQsAnJLu-Z_Za8422LYKnFJ8glwQkkwojiO9YuSd1A8NRPiZbbLP60UGXavmNwhc-iHugZ_eYYqMypkwegcNV6HoxJhbzo_68pOvSrzNbAFF5G_s9yXShpfBlWZWdtH6dJG15STqR9ZpI2TuHUgSu8d5IN81ydfE_uVeqyFiaUskd-dpPixBdwXCs9whx4TM1cwkCOOgV1pHchmIsVelBpnRXrIr43LjBplTwk4H7n8Ix6ZaNmfpwRBMUQZd_zK2zudWnirfRe5vmt8RMCGNBl_m9TLlx9H4MCTie6dLq7joO1ucqmPDkrVM9H2hujt9kyBD3f7b-bxk3s2aQdooAORBW3FC_dAHOxe-Nq1HplGushiNhI4TGM2atJIzBLuTTc7HYsFQMoi0PJ1RO2UNNKkAYqdI4g-d6qyb5Xz5REWJ7uL0uuDLkKWWpby6_zgqivf0lFsl1crfN-E8uhFfAuQ5lmvDM4oMIB6yn-oeFrR4VVQROnnZUAwoQpEBlhntU2gg1rbPdxGU1XpRGocZKTVMa8LZkaDPx0QjFsLmWXmkg4JHZ14ILDDAZA717sk_W8yv15xpi8zcXeiGyQytJ2AYEp6k1_AmvunCazN_36xFGeT8w8GL_LdMamfRxIg22W1PiPDe3RISKQX2AQ2WpG_tSlflj7VVAPx2cEvsqBcKUnsORkqRVUKb9eqOdZPn8g.wTkXo2Ye3kP-09PHfUxEvw';
$sheetLink = 'https://script.google.com/macros/s/AKfycbxR9OBxf0v5zjVfSG-zsYnkmqLnzyklqJ8bW2ZTRUctHpFT4Sw4FKuR-6l12en89nQ/exec';


session_start();
$try  = 0;
if (isset($_POST['try'])) {
  $try = $_POST['try']+1;
  if ($try == 1){
    $day = $_POST['day'];
    $days = $_POST['days'];

    $orgDate = $day;  
    $newDate1 = date("m-d-Y", strtotime($orgDate));  
    $date = str_replace('-', '/', $newDate1);  
    $newDate = date("m/d/Y", strtotime($date));  

    $dateVal = $day;
    $dropDate = date('m/d/Y', strtotime($dateVal. ' + ' . $days . ' days'));

    $row = 1;
    if (($handle = fopen("location.csv", "r")) !== FALSE) {
        ob_start();
        // Set PHP headers for CSV output.
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=car_rental.csv');

        // Create the headers.
        $header_args = array( 'PickDate', 'DropDate', 'LocationCode', 'State', 'City', 'Address', 'Fulladdress', 'Class', 'Type', 'payNowPrice', 'payLaterPrice', 'Link');

        $csvdata = array(
            // array( 'PickDate', 'DropDate', 'LocationCode', 'State', 'City', 'Address', 'Fulladdress', 'Class', 'Type', 'payNowPrice', 'payLaterPrice', 'Link')
        );

        
        while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
            $num = count($data);
            $row++;
            for ($c=0; $c < $num; $c++) {
                $eachData = explode('/', $data[$c]);
                if (strpos($data[$c], "https://www.avis.com") !== false){
                    $add = $eachData[count($eachData) - 1];
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'https://www.avis.com/webapi/reservation/vehicles',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS =>'{
                            "rqHeader":{"brand":"","locale":"en_US"},
                            "nonUSShop":true,
                            "pickInfo":"' . $add . '",
                            "pickDate":"' . $date .'",
                            "pickTime":"12:00 PM",
                            "dropInfo":"' . $add . '",
                            "dropDate":"' . $dropDate . '",
                            "dropTime":"12:00 PM",
                            "couponNumber":"",
                            "couponInstances":"",
                            "couponRateCode":"",
                            "discountNumber":"",
                            "rateType":"",
                            "residency":"US",
                            "age":25,
                            "wizardNumber":"","lastName":"","userSelectedCurrency":"","selDiscountNum":"","promotionalCoupon":"","preferredCarClass":"","membershipId":"","noMembershipAvailable":false,"corporateBookingType":"","enableStrikethrough":"true","amazonGCPayLaterPercentageVal":"","amazonGCPayNowPercentageVal":"","corporateEmailID":""}',
                        CURLOPT_HTTPHEADER => array(
                            'bookingType: car',
                            'channel: Digital',
                            'Content-Type: application/json',
                            'deviceType: bigbrowser',
                            'password: AVISCOM',
                            'userName: AVISCOM',
                            'Referer: https://www.avis.com/en/locations/us/fl/clearwater',
                            'digital-token: ' . $digitoken,
                            'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36',
                            'cookie: ' . $mycookie
                        ),
                    ));

                    $response = curl_exec($curl);

                    curl_close($curl);
                    $data = json_decode($response, false);

                    $carAmount = count($data->vehicleSummaryList);
                    for ($ca=0; $ca < $carAmount; $ca++) {
                        $state = $data->reservationSummary->pickLoc->address->state;
                        $city = $data->reservationSummary->pickLoc->address->city;
                        $Address = $data->reservationSummary->pickLoc->address->address1;
                        $Class = $data->vehicleSummaryList[$ca]->carGroup;
                        $Model = $data->vehicleSummaryList[$ca]->makeModel;
                        $fullAddr = $data->reservationSummary->pickLoc->address->address1 
                                    . $data->reservationSummary->pickLoc->address->city 
                                    . $data->reservationSummary->pickLoc->address->state 
                                    . $data->reservationSummary->pickLoc->address->zipCode 
                                    . $data->reservationSummary->pickLoc->address->country;

                        $newRow = array(
                            strval($date),
                            strval($dropDate),
                            strval($add),
                            strval($data->reservationSummary->pickLoc->address->state),
                            strval($data->reservationSummary->pickLoc->address->city),
                            strval($data->reservationSummary->pickLoc->address->address1),
                            strval($fullAddr),
                            strval($data->vehicleSummaryList[$ca]->carGroup),
                            strval($data->vehicleSummaryList[$ca]->makeModel),
                            strval($data->vehicleSummaryList[$ca]->payNowRate->amount . $data->vehicleSummaryList[$ca]->payNowRate->currency),
                            strval($data->vehicleSummaryList[$ca]->payLaterRate->amount . $data->vehicleSummaryList[$ca]->payLaterRate->currency),
                            strval($data->webHeader->p13nDetailsMap->referrer),
                        );
                        array_push($csvdata, array(
                            strval($date),
                            strval($dropDate),
                            strval($add),
                            strval($data->reservationSummary->pickLoc->address->state),
                            strval($data->reservationSummary->pickLoc->address->city),
                            strval($data->reservationSummary->pickLoc->address->address1),
                            strval($fullAddr),
                            strval($data->vehicleSummaryList[$ca]->carGroup),
                            strval($data->vehicleSummaryList[$ca]->makeModel),
                            strval($data->vehicleSummaryList[$ca]->payNowRate->amount . $data->vehicleSummaryList[$ca]->payNowRate->currency),
                            strval($data->vehicleSummaryList[$ca]->payLaterRate->amount . $data->vehicleSummaryList[$ca]->payLaterRate->currency),
                            strval($data->webHeader->p13nDetailsMap->referrer),
                        ));
                        // $rows = [$newRow]; 
                        
                        // $curl1 = curl_init();

                        // curl_setopt_array($curl1, array(
                        //     CURLOPT_URL => $sheetLink,
                        //     CURLOPT_RETURNTRANSFER => true,
                        //     CURLOPT_ENCODING => '',
                        //     CURLOPT_MAXREDIRS => 10,
                        //     CURLOPT_TIMEOUT => 0,
                        //     CURLOPT_FOLLOWLOCATION => true,
                        //     CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        //     CURLOPT_CUSTOMREQUEST => 'POST',
                        //     CURLOPT_POSTFIELDS => array(
                        //         'PickDate' => $date,
                        //         'DropDate' => $dropDate,
                        //         'LocationCode' => $add,
                        //         'State' => $data->reservationSummary->pickLoc->address->state,
                        //         'City' => $data->reservationSummary->pickLoc->address->city,
                        //         'Address' => $data->reservationSummary->pickLoc->address->address1,
                        //         'Fulladdress' => $fullAddr,
                        //         'Class' => $data->vehicleSummaryList[$ca]->carGroup,
                        //         'Type' => $data->vehicleSummaryList[$ca]->makeModel,
                        //         'payNowPrice' => $data->vehicleSummaryList[$ca]->payNowRate->amount . $data->vehicleSummaryList[$ca]->payNowRate->currency,
                        //         'payLaterPrice' => $data->vehicleSummaryList[$ca]->payLaterRate->amount . $data->vehicleSummaryList[$ca]->payLaterRate->currency,
                        //         'Link' => $data->webHeader->p13nDetailsMap->referrer,
                        //         'formDataNameOrder' => '["PickDate","DropDate","LocationCode","State","City","Address","Fulladdress","Class","Type","payNowPrice","payLaterPrice","Link"]',
                        //         'formGoogleSheetName' => 'responses',
                        //         'formGoogleSendEmail' => 'edmonddantes000313@gmail.com'),
                        //     ));

                        // $response1 = curl_exec($curl1);

                        // curl_close($curl1);
                        // echo $response;


                        echo "Pick Date: ";
                        echo $date . "<br>";
                        echo "  Drop Date: ";
                        echo $dropDate . "<br>";
                        echo "  Location Code: ";
                        echo $add . "<br>";
                        echo "  State: ";
                        echo $data->reservationSummary->pickLoc->address->state . "<br>";
                        // echo "  City: ";
                        // echo $data->reservationSummary->pickLoc->address->city . "<br>";
                        // echo "  Address: ";
                        // echo $data->reservationSummary->pickLoc->address->address1 . "<br>";
                        // echo "  Full address: ";
                        // echo $data->reservationSummary->pickLoc->address->address1 . " ";
                        // echo $data->reservationSummary->pickLoc->address->city . " ";
                        // echo $data->reservationSummary->pickLoc->address->state . " ";
                        // echo $data->reservationSummary->pickLoc->address->zipCode . " ";
                        // echo $data->reservationSummary->pickLoc->address->country . "<br>";
                        // echo "  Class: ";
                        // echo $data->vehicleSummaryList[$ca]->carGroup . "<br>";
                        // echo "  Type: ";
                        // echo $data->vehicleSummaryList[$ca]->makeModel . "<br>";
                        // echo "  payNowPrice: ";
                        // echo $data->vehicleSummaryList[$ca]->payNowRate->amount . $data->vehicleSummaryList[$ca]->payNowRate->currency . "<br>";
                        // echo "  payLaterPrice: ";
                        // echo $data->vehicleSummaryList[$ca]->payLaterRate->amount . $data->vehicleSummaryList[$ca]->payLaterRate->currency . "<br>";
                        // echo "  Link: ";
                        // echo $data->webHeader->p13nDetailsMap->referrer . "<br>";
                        // echo "<br>";
                    }
                    // echo "<br>";
                }
            }
        }

        ob_end_clean();

        // Create a file pointer with PHP.
        $output = fopen( 'php://output', 'w' );

        // Write headers to CSV file.
        fputcsv( $output, $header_args );

        // Loop through the prepared data to output it to CSV file.
        foreach( $csvdata as $data_item ){
            fputcsv( $output, $data_item );
        }

        // Close the file pointer with PHP with the updated output.
        fclose( $output );
        exit;

        fclose($handle);
    }
    }  
} 
?>

<!DOCTYPE html>
<html>

<head>
    <title>
        Car Rental Information
    </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>

<body>
    <div class="formDiv">
        <form id='myForm' name="theForm" action="" autocomplete="off" method="post">
            <div>
                <input type="hidden" name="try" value="<?=(isset($_POST['try']) ? $_POST['try']+1 : 0)?>">
                <p>How many day would you like to rent for?</p>
                <div>
                    <input class="input" type="text" name="days" id="days" style="display:none">
                    <div>
                        <input class="button" type="button" value="30" style="cursor: pointer;" onclick="set30()" id="set301">
                        <input class="button" type="button" value="60" style="cursor: pointer;" onclick="set60()" id="set601">
                        <input class="button" type="button" value="90" style="cursor: pointer;" onclick="set90()" id="set901">
                        <input class="button" type="button" value="330" style="cursor: pointer;" onclick="set330()" id="set3301">
                        <input class="button" type="button" value="custom" style="cursor: pointer;" onclick="setDayCustom()">
                    </div>
                </div>
            </div>
            <div>
                <p>Start from?</p>
                <div>
                    <input class="input" type="date" name="day" id="day" style="display:none">
                    <div>
                        <input class="button" type="button" value="Today" style="cursor: pointer;" onclick="setToday()" id="setToday" disabled>
                        <input class="button" type="button" value="Tomorrow" style="cursor: pointer;" onclick="setTomorrow()" id="setTomorrow" disabled>
                        <input class="button" type="button" value="next month" style="cursor: pointer;" onclick="setMonth()" id="setMonth" disabled>
                        <input class="button" type="button" value="custom" style="cursor: pointer;" onclick="setFromCustom()">
                    </div>
                </div>
            </div>
            <div>
                <input class="button" type="button" value="Export" style="width: 100%" onclick="document.getElementById('myForm').submit()">
            </div>  
            
        </form>  
    </div>
</body>
<style>
    *{
        font-family: sans-serif;
        font-size: 20px;
    }
    .formDiv{
        display: flex;
        justify-content: center;
        align-items: center;
        height: 500px;
        width: 600px;
        background-color: white;
        border-radius: 50px;
    }
    body{
        background-color: gainsboro;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .input{
        width: 100%;
    }
    div{
        margin: 10px;
    }
    .button {
        cursor: pointer;
        background-color: yellow;
        border-radius: 15px;
        min-width: 80px;
        min-height: 40px;
        border-color: white;
        padding: 10px;
    }
    .button:active  {
        background-color: wheat;
    }
</style>
<script>
    function set30(){
        $("#days").val(30)
        resetDay()
        $("#set301").css("background-color", "darkorange")
    }
    function set60(){
        $("#days").val(60)
        resetDay()
        $("#set601").css("background-color", "darkorange")
    }
    function set90(){
        $("#days").val(90)
        resetDay()
        $("#set901").css("background-color", "darkorange")
    }
    function set330(){
        $("#days").val(330)
        resetDay()
        $("#set3301").css("background-color", "darkorange")
    }
    function setDayCustom(){
        $("#days").css("display", "block")
        resetDay()
    }
    function resetDay() {
        $("#set301").css("background-color", "yellow")
        $("#set601").css("background-color", "yellow")
        $("#set901").css("background-color", "yellow")
        $("#set3301").css("background-color", "yellow")
    }
    function setToday(){
        var datepicker = $('#day');
        // datepicker.datepicker();
        datepicker.datepicker('setDate', new Date());
    }
    function setFromCustom(){
        $("#day").css("display", "block")
    }
</script>
</html>